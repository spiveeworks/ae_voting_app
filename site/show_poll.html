<!DOCTYPE html>
<html>
<body>

<script type="module">
    import * as sk from "../sidekick.js";

    function connect(logger) {
        return sk.connect(
            'ske-connect-1',
            {name: 'sidekick examples',
             version: 1},
            sk.TIMEOUT_DEF_CONNECT_MS,
            "failed to connect to wallet",
            logger
        );
    }

    function sign_tx(logger, tx) {
        let sign_params = {
            tx: tx,
            returnSigned: true,
            networkId: "ae_uat"
        };
        return sk.tx_sign_noprop('sk-tx-sign-1', sign_params, sk.TIMEOUT_DEF_TX_SIGN_NOPROP_MS, 'sign transaction timed out', logger);
    }

    async function address(logger) {
        // try to address to the wallet
        // will fail on timeout error
        // console logger
        let wallet_info = await sk.address(
            'ske-address-1',
            {type: 'subscribe',
             value: 'connected'},
            sk.TIMEOUT_DEF_ADDRESS_MS,
            "failed to address to wallet",
            logger
        );
        if (wallet_info.ok) {
            wallet_info.result = Object.keys(wallet_info.result.address.current)[0];
        }

        return wallet_info;
    }

    async function post_json(url, body) {
        let response = await fetch(
            window.location.origin + url,
            {
                method: "post",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            }
        );

        if (response.ok) {
            let body = await response.json();
            return {ok: true, body: body};
        } else {
            return response;
        }
    }

    async function vote(option_id) {
        let logger = sk.cl();

        let poll_id = Number(getID());

        // connect
        let connect_info = await connect(logger);
        if (!connect_info.ok) return;

        // get wallet address
        // TODO: do this as a "login" function, before even showing buttons
        let info = await address(logger);
        if (!info.ok) return;

        // form tx

        let tx_req_body = {
            poll_id: poll_id,
            option_id: option_id,
            address: info.result
        };
        let tx_resp = await post_json("/api/formVoteTX", tx_req_body);
        if (!tx_resp.ok) return;

        let tx = tx_resp.body.tx;

        // sign tx
        let signed_result = await sign_tx(logger, tx);
        if (!signed_result.ok) return;

        let signed_tx = signed_result.result.signedTransaction;

        // post tx
        let post_req_body = {
            poll_id: poll_id,
            option_id: option_id,
            address: info.result,
            signed_tx: signed_tx
        };
        let post_resp = await post_json("/api/postVoteTX", post_req_body);

        // TODO: show pending vote? option currently voted for? revoke button?
    }

    function makeVoteClosure(option_id) {
        async function it() {
            vote(option_id);
        }
        return it;
    }

    function generateTable(data) {
        let table = document.querySelector("table");

        for (let element of data) {
            let row = table.insertRow();

            row.insertCell()
               .appendChild(document.createTextNode(element.name));
            row.insertCell()
               .appendChild(document.createTextNode(element.score));

            let button = document.createElement('button');
            button.innerText = "Vote";
            button.onclick = makeVoteClosure(element.id);
            row.insertCell()
               .appendChild(button);
        }

        // Generate the head AFTER the body, because of course.
        let thead = table.createTHead();
        let row = thead.insertRow();

        let th1 = document.createElement("th");
        th1.appendChild(document.createTextNode("Option"));
        row.appendChild(th1);

        let th2 = document.createElement("th");
        th2.appendChild(document.createTextNode("Score"));
        row.appendChild(th2);
    }

    async function updatePolls() {
        let id = getID();
        document.getElementById("title").innerHTML = "Poll " + id;

        let response = await fetch(window.location.origin + "/api/poll/" + id);
        if (response.ok) {
            let object = await response.json();

            document.getElementById("title").innerHTML = object.title;
            document.getElementById("description").innerHTML = object.description;

            generateTable(object.options);
        } else if (response.status == 404) {
            document.getElementById("description").innerHTML = "Not found.";
        } else if (response.status == 500) {
            document.getElementById("description").innerHTML = "Server error.";
        }
    }

    function getID() {
        let text = document.getElementById("text");
        let path = window.location.pathname.split("/");
        let id_str = path[path.length - 1];
        return id_str; // We could convert this to a number, but it only ever gets used to build HTTP request URLs, so there is no need.
    }

    window.onload = updatePolls;
    //setInterval(updateCounter, 1000);
</script>

<h1 id="title"></h1>

<p id="description">Loading poll...</p>

<table>
<!-- to be generated client-side --!>
</table>

</body>
</html>

