<!DOCTYPE html>
<html>
<body>

<script type="module">
    import * as sk from "../sidekick.js";
    import * as aev from "/aev_util.js";

    var polls_loaded = false;

    async function login() {
        let login_success = await aev.login();
        if (!login_success) return;

        if (!polls_loaded) {
            // There may be unregistered polls, so use authority to display them.
            let submit_resp = await aev.request_and_sign("/api/unregisteredPolls", {});
            if (submit_resp.ok) {
                console.log(submit_resp);
                let polls = submit_resp.body.unregistered_polls;

                // flag to make sure we don't add to the tables twice
                polls_loaded = true;

                generatePollTable(polls);
            }
        }
    }

    function generatePollRow(table, title, contract_address) {
        let row = table.insertRow();

        row.insertCell()
           .appendChild(document.createTextNode(title));
        row.insertCell()
           .appendChild(document.createTextNode(contract_address));

        let register = document.createElement("button");
        register.addEventListener("click", registerPollCallback);
        register.innerText = "register";
        row.insertCell()
            .appendChild(register);

        if (table.rows.length == 1) {
            // Generate the head as soon as one row is added
            let thead = table.createTHead();
            let row = thead.insertRow();

            let th1 = document.createElement("th");
            th1.appendChild(document.createTextNode("Title"));
            row.appendChild(th1);

            let th2 = document.createElement("th");
            th2.appendChild(document.createTextNode("Address"));
            row.appendChild(th2);
        }
    }

    function generatePollTable(polls) {
        let out = document.getElementById("unregistered_list_status");

        let table = document.getElementById("unregistered_polls_table");

        if (polls.length == 0) {
            out.textContent = "There were no unregistered polls when you selected this account.";
        } else {
            out.textContent = "";
            for (let poll of polls) {
                generatePollRow(table, poll.title, poll.contract_address);
            }
        }
    }

    async function registerPoll(contract_address) {
        let request = {
            contract_address: contract_address
        };

        let post_resp = await aev.form_and_post("/api/registerPoll", request);

        let out = document.getElementById("unregistered_list_status");
        if (post_resp.ok) {
            out.textContent = "Poll is being registered.";
            // remove rows from the table with this contract address
            let table = document.getElementById("unregistered_polls_table");
            let rows = table.rows;
            for (var i = 1; i < rows.length; i++) {
                let this_address = rows[i].cells[1].textContent;
                if (contract_address == this_address) {
                    table.deleteRow(i);
                    // decrement to cancel out the loop increment, to check the row that replaces this one
                    i--;
                }
            }
            if (table.rows.length == 1) {
                // the only row left is the header, so remove that too
                table.deleteRow(0);
                let count_resp = await fetch("/api/unregisteredPolls/count");
                if (count_resp.ok) {
                    let result = await count_resp.json();
                    if (result.unregistered_count != 0) {
                        out.textContent = "Poll is being registered. Refresh to see remaining unregistered polls.";
                    } else if (result.pending_registration_count != 0) {
                        out.textContent = "Poll is being registered. Refresh to see if it succeeds.";
                    } else if (result.pending_creation_count != 0) {
                        out.textContent = "All polls have been registered, but another is being created. Refresh to see if it gets mined.";
                    } else {
                        out.textContent = "All polls have been registered.";
                    }
                }
            }
        } else {
            out.textContent = "Failed to register poll.";
        }
        return post_resp;
    }

    function registerPollCallback(event) {
        let button = event.target;

        let table = document.getElementById("unregistered_polls_table");
        let rows = table.rows;
        for (var i = 1; i < rows.length; i++) {
            let this_button = rows[i].cells[2].children[0];
            if (button == this_button) { // double equals, yolo
                let out = document.getElementById("unregistered_list_status");
                out.textContent = "Attempting to register contract...";

                let contract_address = rows[i].cells[1].textContent;
                // asynchronous call
                registerPoll(contract_address);
                return;
            }
        }
    }

    function removeOption(event) {
        let button = event.target;

        let table = document.getElementById("option_table");
        let rows = table.rows;
        for (var i = 0; i < rows.length; i++) {
            let this_button = rows[i].cells[2].children[0];
            if (button == this_button) { // double equals, yolo
                table.deleteRow(i);
                for (var j = i; j < rows.length; j++) {
                    let option_text = rows[j].cells[0];
                    option_text.innerText = j;
                }
            }
        }

        if (rows.length <= 3) {
            // There's no point having a poll with fewer than two options, so disable the remove buttons.
            for (var i = 1; i < rows.length; i++) {
                rows[i].cells[2].children[0].disabled = true;
            }
        }
    }

    function addOption(event) {
        let table = document.getElementById("option_table");

        let nextIndex = table.rows.length;
        let row = table.insertRow();

        row.insertCell()
           .appendChild(document.createTextNode(nextIndex));

        let input = document.createElement("input");
        input.type = "text";
        row.insertCell().appendChild(input);

        let remove = document.createElement("button");
        remove.addEventListener("click", removeOption);
        remove.innerText = "remove";
        row.insertCell().appendChild(remove);

        for (var i = 0; i < table.rows.length; i++) {
            table.rows[i].cells[2].children[0].disabled = false;
        }
    }

    async function createPoll(event) {
        let form = event.target;
        let title = form[0].value;
        let description = form[1].value;
        let url = form[2].value;

        let lifetime;
        if (form[3].checked) {
            lifetime = form[4].value;
        } else {
            lifetime = "never_closes";
        }

        let options = [];
        let rows = form.children[1].rows;
        for (var i = 1; i < rows.length; i++) {
            let option_name = rows[i].cells[1].children[0].value;
            options.push(option_name);
        }

        let request = {
            title: title,
            description: description,
            url: url,
            lifetime: lifetime,
            options: options,
            wait_until_mined: true,
        };

        let out = document.getElementById("unregistered_list_status");
        out.textContent = "Attempting to make contract...";

        let post_resp = await aev.form_and_post("/api/createPoll", request);
        if (post_resp.ok && post_resp.body.contract_id != "not_mined") {
            let contract_id = post_resp.body.contract_id;

            let table = document.getElementById("unregistered_polls_table");
            generatePollRow(table, title, contract_id);

            out.textContent = "Contract created. Attempting to register contract...";
            let register_resp = await
            // asynchronous call
            registerPoll(contract_id);
        } else {
            out.textContent = "Refresh to check if a transaction has been mined.";
        }
    }

    async function updateButtons() {
        let login_button = document.getElementById("login_button");
        login_button.innerText = "Select account";
        login_button.onclick = login;

        let form = document.querySelector("form");
        form.addEventListener("submit", createPoll);

        let add_option_button = document.getElementById("add_option_button");
        add_option_button.addEventListener("click", addOption);

        let option_table = document.getElementById("option_table");
        for (var i = 1; i < option_table.rows.length; i++) {
            let remove_button = option_table.rows[i].cells[2].children[0];
            remove_button.disabled = true;
            remove_button.addEventListener("click", removeOption);
        }

        let count_resp = await fetch("/api/unregisteredPolls/count");
        let status = document.getElementById("unregistered_list_status");
        if (count_resp.ok) {
            let result = await count_resp.json();
            if (result.unregistered_count == 0) {
                polls_loaded = true;

                if (result.pending_registration_count != 0) {
                    status.textContent = "There is a poll still being registered, refresh to see if it has been mined.";
                } else if (result.pending_creation_count != 0) {
                    status.textContent = "There is a poll still being created, refresh to see if it has been mined.";
                } else {
                    status.textContent = "There were no unregistered polls when you last refreshed.";
                }
            }
        }
        if (!polls_loaded) {
            status.textContent = "Select account to view unregistered polls.";
        }
    }

    window.onload = updateButtons;
    //setInterval(updateCounter, 1000);
</script>

<p id="login_status">No account selected.</p>

<button id="login_button">Loading...</button>

<h2>Unregistered Polls</h2>

<p id="unregistered_list_status">Checking to see if there are unregistered polls...</p>

<table id="unregistered_polls_table">
<!-- to be generated client-side --!>
</table>

<h2>Create a New Poll</h2>

<form onsubmit="return false;" accept-charset="utf-8">
    <table>
    <tr>
        <th>Field</th>
        <th>Value</th>
    </tr>
    <tr>
        <td>Title</td>
        <td>
            <input type="text" name="title"/>
        </td>
    </tr>
    <tr>
        <td>Description</td>
        <td>
            <input type="text" name="description"/>
        </td>
    </tr>
    <tr>
        <td>URL</td>
        <td>
            <input type="text" name="url"/>
        </td>
    </tr>
    <tr>
        <td>Closes?</td>
        <td>
            <input type="checkbox" name="closes"/>
        </td>
    </tr>
    <tr>
        <td>Lifetime (blocks)</td>
        <td>
            <input type="number" name="lifetime"/>
        </td>
    </tr>
    </table>

    <table id="option_table">
    <tr>
        <th>Option</th>
        <th>Name</th>
        <td><button id="add_option_button">add option</button></td>
    </tr>
    <tr>
        <td>1</td>
        <td>
            <input type="text"/>
        </td>
        <td><button disabled="true">remove</button></td>
    </tr>
    <tr>
        <td>2</td>
        <td>
            <input type="text"/>
        </td>
        <td><button disabled="true">remove</button></td>
    </tr>
    </table>

    <input type="submit" value="Create"/>
</form>
</body>
</html>

